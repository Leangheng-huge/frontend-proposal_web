<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Romantic Proposal App</title>
<style>
    * {margin:0; padding:0; box-sizing:border-box;}
    body {font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height:100vh; display:flex; justify-content:center; align-items:center;}
    .page {display:none; width:100%; min-height:100vh;}
    .page.active {display:flex; justify-content:center; align-items:center; flex-direction:column;}
    .container {background:white; padding:40px; border-radius:15px; box-shadow:0 10px 40px rgba(0,0,0,0.2); width:90%; max-width:400px; text-align:center;}
    h1 {margin-bottom:30px;}
    .form-group {margin-bottom:20px; text-align:left;}
    .form-group label {display:block; margin-bottom:8px; color:#555; font-weight:500;}
    .form-group input {width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; transition:border-color 0.3s;}
    .form-group input:focus {outline:none; border-color:#667eea;}
    .btn {width:100%; padding:14px; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:all 0.3s;}
    .btn-primary {background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white;}
    .btn-primary:hover {transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,0.4);}
    .toggle-link {margin-top:15px; display:block; cursor:pointer; color:#667eea;}
    .error-message {color:#e74c3c; font-size:14px; margin-top:10px; display:none;}
    .success-message {color:#27ae60; font-size:14px; margin-top:10px; display:none;}
    /* Dashboard */
    #dashboardPage .container {max-width:600px;}
    .link-section {background:#f8f9fa; padding:25px; border-radius:10px; margin:20px 0;}
    .link-display {background:white; padding:15px; border-radius:8px; border:2px solid #e0e0e0; word-break:break-all; color:#667eea;}
    .btn-copy {background:#667eea; color:white; padding:12px 30px; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600;}
    .btn-copy:hover {background:#5568d3;}
    .notification-area {margin-top:20px; padding:20px; border-radius:10px; display:none;}
    .notification-area.show {display:block;}
    .notification-area.success {background:#d4edda; border:2px solid #c3e6cb; color:#155724;}
    .notification-area.rejection {background:#f8d7da; border:2px solid #f5c6cb; color:#721c24;}
    .loading {text-align:center; color:#666; margin-top:20px;}
    /* Proposal */
    .proposal-container {background:white; padding:50px; border-radius:20px; box-shadow:0 15px 50px rgba(0,0,0,0.2); max-width:500px; width:90%; text-align:center;}
    .heart {font-size:60px; margin-bottom:30px; animation:heartbeat 1.5s infinite;}
    @keyframes heartbeat {0%,100%{transform:scale(1);}25%{transform:scale(1.1);}}
    .button-group {display:flex; gap:20px; margin-top:30px;}
    .btn-yes {flex:1; background:linear-gradient(135deg,#ff6b9d 0%,#ffc371 100%); color:white; padding:18px; border:none; border-radius:12px; font-size:20px; font-weight:700; cursor:pointer;}
    .btn-no {flex:1; background:#6c757d; color:white; padding:18px; border:none; border-radius:12px; font-size:20px; font-weight:700; cursor:pointer;}
    /* Response */
    .response-message {text-align:center; padding:40px; max-width:800px;}
    #yesResponsePage {background:#FFC0CB;}
    #noResponsePage {background:#000000;}
    #yesResponsePage .response-message h1, #noResponsePage .response-message h1 {color:#fff; font-size:48px; animation:fadeInScale 1s ease-out;}
    @keyframes fadeInScale {from{opacity:0; transform:scale(0.8);} to{opacity:1; transform:scale(1);}}
    .hearts-animation {position:fixed; width:100%; height:100%; pointer-events:none;}
    .floating-heart {position:absolute; font-size:30px; animation:floatUp 5s infinite; opacity:0;}
    @keyframes floatUp {0%{opacity:0; transform:translateY(0);}50%{opacity:1;}100%{opacity:0; transform:translateY(-100vh);}}
    @media(max-width:600px){.proposal-container h1{font-size:24px;}.response-message h1{font-size:32px !important;}.button-group{flex-direction:column;}}
</style>
</head>
<body>
<!-- Login Page -->
<div id="loginPage" class="page active">
    <div class="container">
        <h1>üíï Romantic Proposal</h1>
        <form id="loginForm">
            <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
            <div class="form-group"><label>Password</label><input type="password" id="password" required></div>
            <button type="submit" class="btn btn-primary">Login</button>
            <div class="error-message" id="loginError"></div>
        </form>
        <span class="toggle-link" onclick="showPage('registerPage')">Don't have an account? Register</span>
    </div>
</div>

<!-- Register Page -->
<div id="registerPage" class="page">
    <div class="container">
        <h1>Register</h1>
        <form id="registerForm">
            <div class="form-group"><label>Email</label><input type="email" id="regEmail" required></div>
            <div class="form-group"><label>Password</label><input type="password" id="regPassword" required></div>
            <button type="submit" class="btn btn-primary">Register</button>
            <div class="error-message" id="registerError"></div>
        </form>
        <span class="toggle-link" onclick="showPage('loginPage')">Already have an account? Login</span>
    </div>
</div>

<!-- Dashboard Page -->
<div id="dashboardPage" class="page">
    <div class="container">
        <h1>Welcome, <span id="welcomeEmail"></span>! üíñ</h1>
        <p style="color:#666;">Share this special link with someone you love</p>
        <div class="link-section">
            <div class="link-display" id="shareableLink">Creating your proposal...</div>
            <button class="btn-copy" onclick="copyLink()">üìã Copy Link</button>
        </div>
        <div class="notification-area" id="notificationArea">
            <h3>Response Received!</h3>
            <p id="notificationMessage"></p>
        </div>
        <div class="loading" id="loadingStatus">Waiting for response...</div>
    </div>
</div>

<!-- Proposal Page -->
<div id="proposalPage" class="page">
    <div class="proposal-container">
        <div class="heart">‚ù§Ô∏è</div>
        <h1>Will you be with me?</h1>
        <h4>Please answer honestly; I will respect your choice.üòâ</h4>
        <div class="button-group">
            <button class="btn-yes" onclick="respondToProposal('YES')">Yes! üíï</button>
            <button class="btn-no" onclick="respondToProposal('NO')">No, sorry</button>
        </div>
    </div>
</div>

<!-- Yes Response Page -->
<div id="yesResponsePage" class="page">
    <div class="hearts-animation" id="heartsAnimation"></div>
    <div class="response-message">
        <h1>I love you since a long time!!</h1>
    </div>
</div>

<!-- No Response Page -->
<div id="noResponsePage" class="page">
    <div class="response-message">
        <h1>It's okay, I respect your choice.üòÑ</h1>
    </div>
</div>

<script>
const API_BASE_URL = 'http://localhost:8080/api';
let currentUser=null;
let currentProposalId=null;
let statusCheckInterval=null;

function showPage(pageId){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(pageId).classList.add('active');}

// Login
document.getElementById('loginForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const email=document.getElementById('email').value;
    const password=document.getElementById('password').value;
    const errorDiv=document.getElementById('loginError');
    errorDiv.style.display='none';
    try{
        const res=await fetch(`${API_BASE_URL}/auth/login`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
        const data=await res.json();
        if(!res.ok) throw new Error(data.message);
        currentUser={email:data.email, token:data.token, userId:data.userId};
        document.getElementById('welcomeEmail').textContent=email;
        showPage('dashboardPage');
        await createProposal();
    }catch(err){errorDiv.textContent=err.message; errorDiv.style.display='block';}
});

// Register
document.getElementById('registerForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const email=document.getElementById('regEmail').value;
    const password=document.getElementById('regPassword').value;
    const errorDiv=document.getElementById('registerError');
    errorDiv.style.display='none';
    try{
        const res=await fetch(`${API_BASE_URL}/auth/register`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
        const data=await res.json();
        if(!res.ok) throw new Error(data.message);
        alert('Registration successful! Please login.');
        showPage('loginPage');
    }catch(err){errorDiv.textContent=err.message; errorDiv.style.display='block';}
});

// Create Proposal
async function createProposal(){
    try{
        const res=await fetch(`${API_BASE_URL}/proposal/create`,{method:'POST', headers:{'Authorization':`Bearer ${currentUser.token}`, 'Content-Type':'application/json'}});
        const data=await res.json();
        if(!res.ok) throw new Error('Failed to create proposal');
        currentProposalId=data.proposalId;
        document.getElementById('shareableLink').textContent=data.shareableLink;
        startStatusCheck();
    }catch(err){console.error(err); document.getElementById('shareableLink').textContent='Error creating link.';}
}

// Copy Link
function copyLink(){
    const linkText=document.getElementById('shareableLink').textContent;
    navigator.clipboard.writeText(linkText).then(()=>{alert('Link copied!');});
}

// Check proposal status
function startStatusCheck(){statusCheckInterval=setInterval(checkProposalStatus,5000);}
async function checkProposalStatus(){
    try{
        const res=await fetch(`${API_BASE_URL}/proposal/${currentProposalId}/status`,{headers:{'Authorization':`Bearer ${currentUser.token}`}});
        const data=await res.json();
        if(data.answered){clearInterval(statusCheckInterval); showNotification(data.response,data.notification);}
    }catch(err){console.error(err);}
}
function showNotification(response,message){
    const area=document.getElementById('notificationArea');
    const msg=document.getElementById('notificationMessage');
    const loading=document.getElementById('loadingStatus');
    loading.style.display='none';
    area.classList.add('show');
    if(response==='YES') area.classList.add('success'); else area.classList.add('rejection');
    msg.textContent=message;
}

// Respond to Proposal
async function respondToProposal(response){
    const urlParams=new URLSearchParams(window.location.search);
    const proposalToken=urlParams.get('proposal');
    if(!proposalToken){alert('Invalid link'); return;}
    try{
        const res=await fetch(`${API_BASE_URL}/proposal/${proposalToken}/respond`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({response})});
        if(!res.ok) throw new Error('Failed to submit response');
        if(response==='YES'){showPage('yesResponsePage'); createFloatingHearts();}
        else{showPage('noResponsePage');}
    }catch(err){alert('Error submitting response');}
}

// Floating Hearts
function createFloatingHearts(){
    const container=document.getElementById('heartsAnimation');
    setInterval(()=>{
        const heart=document.createElement('div');
        heart.className='floating-heart';
        heart.textContent='‚ù§Ô∏è';
        heart.style.left=Math.random()*100+'%';
        heart.style.animationDuration=(Math.random()*3+3)+'s';
        container.appendChild(heart);
        setTimeout(()=>heart.remove(),6000);
    },500);
}

// Proposal Page detection
window.addEventListener('DOMContentLoaded',()=>{
    const urlParams=new URLSearchParams(window.location.search);
    const proposalToken=urlParams.get('proposal');
    if(proposalToken){showPage('proposalPage');}
});
</script>
</body>
</html>
